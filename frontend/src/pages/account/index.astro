---
import Auth from "../../layouts/auth.astro";
import CreateTable from "../../components/table";

if (!Astro.cookies.has('token')) {
    return Astro.redirect('/auth/login');
}

let type = Astro.cookies.get('type').value;
let id = null;
if(type === 'emp'){
    id = Astro.cookies.get('emp').value
}
else{
    id = Astro.cookies.get('doc').value
}
if(type == "doc"){
    type = "doctors"
}
let data = null

const res = await fetch(`http://localhost:2468/${type}/${id}`, {
    method: 'GET',
    headers: {
        'Authorization': Astro.cookies.get('token').value
    }
}).then(res => res.json()).catch((err)=>console.log(err))

const patient_res = await fetch(`http://localhost:2468/all`, {
    method: 'GET',
    headers: {
        'Authorization': Astro.cookies.get('token').value
    }
}).then(res => res.json()).catch((err)=>console.log(err))

//get all the patients with doc_id = id
const patients = patient_res.filter((patient)=>patient.doc_id === parseInt(id))

data = res
---

<Auth>
    <div>
        <div class="pt-5 px-5">
            <h2 class="text-3xl font-bold">
                Welcome
                {
                    type === 'emp' ? '🧑‍🏭 ' : '🧑‍⚕️ '
                }
                <span class="underline">{data.full_name}</span>
            </h2>
            <p class="py-3">
                To your premium {
                    type === 'emp' ? 'employee' : 'doctor'
                } dashboard.
            </p>
        </div>
        <div class="mx-5">
            <CreateTable initial={patients} query="display" default_term={''} title={`Patients by ${data.full_name}`} client:load/>
        </div>
    </div>
</Auth>