---
import Auth from "../../layouts/auth.astro";
import Payment from "../../components/small/payment";
import DeletePatient from "../../components/small/delete";
import Appointment from "../../components/small/appointment";
import {Button} from "@/components/ui/button"


const {hash} = Astro.params

if(Astro.cookies.get('token') == null){
    return Astro.redirect('/auth/login')
}

const res = await fetch(`http://localhost:4321/api/patients`, {
    method: 'GET',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': Astro.cookies.get('token')?.value || '',
        'p_id': hash || ''
    }
})

const data = await res.json()
if(data == null){
    return Astro.redirect('/404')
}

const doc_id = data.doc_id
const doc_res = await fetch(`http://localhost:4321/api/doctor`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': Astro.cookies.get('token')?.value || '',
            'doc_id': doc_id || ''
        }
    }).then((res) => res.json())

const doc = doc_res.full_name

const appointment_time = Math.floor((new Date(data.next_appointment).getTime() - new Date().getTime()) / (1000 * 3600 * 24))
---

<Auth title={"Patient " + data.full_name + " | DocCache"}>
    <div class="flex flex-row items-center justify-center py-10">
        <div class="w-4/5 px-16">
            <h1 class="font-heading text-3xl mb-2">
                Patient <span class="bg-gray-200">{data.p_id}</span>
            </h1>
            <p>
                {' '}<span class="text-base font-sans">{!data.paid && '💵 Pending | '}</span>
                {
                    appointment_time > 0 ? (
                        <span>
                            {
                    data.next_appointment > data.created_at && (
                                <span class="text-gray-600">
                                    📅 Next appointment: {new Date(data.next_appointment).toDateString()}. | ➡️ {appointment_time} In days.
                                </span>
                    )
                }    
                        </span>
                    ): (
                        <span>
                            ❗ Appointment Overdue by {Math.abs(appointment_time)} days.    
                        </span>
                    )
                }
            </p>
            <div class="mt-4 text-lg border-2 gap-y-3 grid border-r-4 border-b-4 border-neutral-800 p-4 rounded-lg shadow-lg">
                <h3>
                    {data.gender == "Male"? "👨" : "👧"}<span class="font-bold">Name:</span>{' '} <span>{data.full_name}</span>
                </h3>
                <p>
                    <span class="font-bold">Phone Number: </span>{' '} <a href=`tel:${data.phone}`>{data.phone}</a>
                </p>
                <p>
                    <span class="font-bold">Age and Gender:</span>{' '} {data.age} year old {data.gender}
                </p>
                <div class="flex flex-row gap-x-2">
                    <p class="font-bold">Description:</p> <p>{data.description}</p>
                </div>
                <p>
                    <span class="font-bold">Last Visited: </span>{' '} {new Date(data.created_at).toDateString()}
                </p>
                <div>
                    <p class="font-bold">Problems</p>
                    <ul class="ml-10 list-disc">
                        {
                            data.problems.split(";").map((problem:any) => {
                                return (
                                        <li>
                                            {problem}
                                        </li>
                                )
                            })
                        }
                    </ul>
                </div>
                <p>
                    <span class="font-bold">Diagnosis: </span>{' '} {data.diagnosis}
                </p>
                <p>
                    <span class="font-bold">🩺 Treated By: </span>{' '} <a class="underline" href={`/doctors/${data.doc_id}`}>Dr. {doc}</a>
                </p>
                <div>
                    <p class="font-bold">💊 Medicines</p>
                    <ul class="ml-10 list-disc">
                        {
                            data.medicines.split(";").map((problem:any) => {
                                return (
                                        <li>
                                            {problem}
                                        </li>
                                )
                            })
                        }
                    </ul>
                </div>
            </div>
        </div>
        <div class="w-1/5 gap-y-8 grid">
            <div class="grid gap-y-2">
                <Button className="text-xl px-3 py-6 w-4/5" client:load><a href={"/update/" + data.p_id}>🔧 Update Details</a></Button>
                <DeletePatient patient={data} client:load />
            </div>
            <div class="grid gap-y-2">
                <Payment patient={data} client:load />
                <Appointment token={Astro.cookies.get('token')?.value || ''} patient={data} client:load />
            </div>
            <div class="grid gap-y-2">
                <Button variant="secondary" className="text-xl px-3 py-6 w-4/5" client:load>🧑‍⚕️ Transfer Doctor️</Button>
                <Button variant="secondary" className="text-xl px-3 py-6 w-4/5" client:load>🖨️ Print Receipt</Button>
            </div>
        </div>
    </div>
</Auth>