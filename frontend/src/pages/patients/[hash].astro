---
import Auth from "../../layouts/auth.astro";
import {Button} from "../../components/ui/button.tsx";

const {hash} = Astro.params

const res = await fetch(`http://localhost:2468/patients/${hash}`, {
    method: 'GET',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': Astro.cookies.get('token').value || ''
    }
})

const data = await res.json()
if(data == null){
    return Astro.redirect('/404')
}

const doc_id = data.doc_id
const doc_res = await fetch(`http://localhost:2468/doctors/${doc_id}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': Astro.cookies.get('token').value || ''
        }
    }).then((res) => res.json())

const doc = doc_res.full_name
---

<Auth title={"Patient " + data.full_name + " | DocCache"}>
    <div class="flex flex-row items-center justify-center py-10">
        <div class="w-4/5 px-16">
            <h1 class="font-heading text-3xl mb-4">
                Patient <span class="bg-gray-200">{data.p_id}</span>
            </h1>
            <div class="text-lg border-2 gap-y-3 grid border-r-4 border-b-4 border-neutral-800 p-4 rounded-lg shadow-lg">
                <h3>
                    {data.gender == "Male"? "ğŸ‘¨" : "ğŸ‘§"}<span class="font-bold">Name:</span>{' '} <span>{data.full_name}</span>
                </h3>
                <p>
                    <span class="font-bold">Phone Number: </span>{' '} <a href=`tel:${data.phone}`>{data.phone}</a>
                </p>
                <p>
                    <span class="font-bold">Age and Gender:</span>{' '} {data.age} year old {data.gender}
                </p>
                <div class="flex flex-row gap-x-2">
                    <p class="font-bold">Description:</p> <p>{data.description}</p>
                </div>
                <p>
                    <span class="font-bold">Last Visited: </span>{' '} {new Date(data.created_at).toDateString()}
                </p>
                <div>
                    <p class="font-bold">Problems</p>
                    <ul class="ml-10 list-disc">
                        {
                            data.problems.split(";").map((problem) => {
                                return (
                                        <li key={problem}>
                                            {problem}
                                        </li>
                                )
                            })
                        }
                    </ul>
                </div>
                <p>
                    <span class="font-bold">Diagnosis: </span>{' '} {data.diagnosis}
                </p>
                <p>
                    <span class="font-bold">ğŸ©º Treated By: </span>{' '} <a class="underline" href={`/docs/${data.doc_id}`}>{doc}</a>
                </p>
                <div>
                    <p class="font-bold">ğŸ’Š Medicines</p>
                    <ul class="ml-10 list-disc">
                        {
                            data.medicines.split(";").map((problem) => {
                                return (
                                        <li key={problem}>
                                            {problem}
                                        </li>
                                )
                            })
                        }
                    </ul>
                </div>
            </div>
        </div>
        <div class="w-1/5 gap-y-8 grid">
            <div class="grid gap-y-2">
                <Button className="text-xl px-3 py-6 w-4/5" client:load>ğŸ”§ Update Details</Button>
                <Button className="text-xl px-3 py-6 w-4/5" client:load>âŒ Delete Entry</Button>
            </div>
            <div class="grid gap-y-2">
                <Button className="text-xl px-3 py-6 w-4/5" client:load>ğŸ–¨ï¸ Print Receipt</Button>
                <Button className="text-xl px-3 py-6 w-4/5" client:load></Button>
            </div>
        </div>
    </div>
</Auth>